<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Apartment Booking Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; background: #f9fafb; padding: 20px; }
    #calendar { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .fc-day-past { background-color: #f0f0f0 !important; pointer-events: none; opacity: 0.6; }
    .fc-day-available { background-color: #d1fae5 !important; }
    .fc-day-selected { background-color: #93c5fd !important; }
    .fc-event { background-color: #f87171 !important; border: none; }
    button { margin: 20px auto; display: block; background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 8px; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Apartment Booking</h2>
  <div id="calendar"></div>
  <button id="bookBtn">Book Selected Dates</button>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwfZJdhqOF0TlffNr-guVtsulbqnDHdnGKV9iMkfMY1xIQBPqlH0B1xfJGWyoAMlNH7lA/exec";
    const urlParams = new URLSearchParams(window.location.search);
    const a_id = urlParams.get("a_id") || "apt001";
    let bookedDates = new Set();
    let selectedDates = new Set();

    async function fetchBookedDates() {
      try {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        bookedDates = new Set(data.dates);
        renderCalendar();
      } catch (err) {
        alert("Error loading booked dates: " + err.message);
      }
    }

    function renderCalendar() {
      const calendarEl = document.getElementById("calendar");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        selectable: true,
        dateClick: function(info) {
          const dateStr = info.dateStr;
          const today = new Date();
          today.setHours(0,0,0,0);

          if (info.date < today || bookedDates.has(dateStr)) return;

          const cell = info.dayEl;
          if (selectedDates.has(dateStr)) {
            selectedDates.delete(dateStr);
            cell.classList.remove("fc-day-selected");
            cell.classList.add("fc-day-available");
          } else {
            selectedDates.add(dateStr);
            cell.classList.add("fc-day-selected");
            cell.classList.remove("fc-day-available");
          }
        },
        datesSet: function() {
          setTimeout(() => {
            document.querySelectorAll(".fc-daygrid-day").forEach(cell => {
              const dateStr = cell.getAttribute("data-date");
              const dateObj = new Date(dateStr);
              const today = new Date();
              today.setHours(0,0,0,0);

              if (dateObj < today) {
                cell.classList.add("fc-day-past");
              } else if (bookedDates.has(dateStr)) {
                cell.classList.add("fc-event");
                cell.style.pointerEvents = "none";
              } else if (!selectedDates.has(dateStr)) {
                cell.classList.add("fc-day-available");
              }
            });
          }, 300);
        }
      });
      calendar.render();
    }

    document.getElementById("bookBtn").onclick = async () => {
      if (selectedDates.size === 0) return alert("No dates selected.");

      const dates = Array.from(selectedDates).sort();
      const confirmMsg = "Confirm booking for:\n\n" + dates.join("\n");
      if (!confirm(confirmMsg)) return;

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ a_id, dates })
        });
        const result = await res.json();
        if (result.status === "success") {
          alert("Booking successful!");
          location.reload();
        } else {
          alert("Booking error: " + result.message);
        }
      } catch (err) {
        alert("Network error: " + err.message);
      }
    };

    fetchBookedDates();
  </script>
</body>
</html>
