<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apartment Booking Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
    #calendar { max-width: 600px; margin: auto; }
    #bookBtn { margin-top: 10px; width: 100%; padding: 10px; font-size: 16px; }
    .fc-daygrid-day {
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
  </style>
</head>
<body>

<h2>Apartment Booking Calendar (apt001)</h2>
<div id="calendar"></div>
<button id="bookBtn" disabled>Book Selected Dates</button>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxKf1SyYft1ClKgZgaaesA0PTf00lRi0Y4X9EHP30-uDzaWlMjz2HC4JTpXFAUDprxEUQ/exec'; // <-- Replace with your Apps Script Web App URL
  const a_id = 'apt001'; // Change apartment ID as needed
  let bookedDates = new Set();
  let pastDates = new Set();
  let selectedDates = new Set();

  // Format Date to YYYY-MM-DD for FullCalendar and easy comparison
  function formatYMD(date) {
    return date.toISOString().split('T')[0];
  }

  // Fetch bookings from backend
  async function fetchBookings() {
    const res = await fetch(`${WEBAPP_URL}?a_id=${a_id}`);
    const data = await res.json();
    if (data.error) {
      alert("Error fetching bookings: " + data.error);
      return [];
    }
    return data.bookings;
  }

  // Expand booking ranges into individual dates
  function expandDates(start, end) {
    let dates = [];
    let current = new Date(start);
    let last = new Date(end);
    while (current <= last) {
      dates.push(formatYMD(current));
      current.setDate(current.getDate() + 1);
    }
    return dates;
  }

  // Initialize calendar
  async function initCalendar() {
    const bookings = await fetchBookings();

    bookedDates.clear();
    bookings.forEach(b => {
      const rangeDates = expandDates(b.start, b.end);
      rangeDates.forEach(d => bookedDates.add(d));
    });

    const today = new Date();
    pastDates.clear();
    // Collect past dates in this month and before
    // (we'll handle past dates on the fly instead)

    const calendarEl = document.getElementById('calendar');

    let calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      // Disable built-in selection, we do manual day clicks
      selectable: false,
      dayCellDidMount: function(info) {
        const dateStr = formatYMD(info.date);

        // Style cells:
        if (info.date < today) {
          // Past dates grey and disabled
          info.el.style.backgroundColor = '#eee';
          info.el.style.color = '#999';
          info.el.style.pointerEvents = 'none';
          info.el.style.cursor = 'default';
        } else if (bookedDates.has(dateStr)) {
          // Booked dates red and disabled
          info.el.style.backgroundColor = '#ff4d4d';
          info.el.style.color = 'white';
          info.el.style.pointerEvents = 'none';
          info.el.style.cursor = 'default';
        } else {
          // Available dates green
          info.el.style.backgroundColor = '#b0f2b6';
          info.el.style.color = '#000';
          info.el.style.pointerEvents = 'auto';
          info.el.style.cursor = 'pointer';

          // Add click listener for selecting/deselecting
          info.el.addEventListener('click', () => {
            toggleDateSelection(dateStr, info.el);
          });
        }
      }
    });

    calendar.render();
  }

  // Toggle date in selectedDates and update cell color
  function toggleDateSelection(dateStr, cellEl) {
    if (selectedDates.has(dateStr)) {
      // Deselect
      selectedDates.delete(dateStr);
      cellEl.style.backgroundColor = '#b0f2b6'; // green
      cellEl.style.color = '#000';
    } else {
      // Select
      selectedDates.add(dateStr);
      cellEl.style.backgroundColor = '#4a90e2'; // blue
      cellEl.style.color = 'white';
    }
    updateBookButton();
  }

  function updateBookButton() {
    const btn = document.getElementById('bookBtn');
    btn.disabled = selectedDates.size === 0;
  }

  // POST new booking
  async function submitBooking() {
    if (selectedDates.size === 0) return alert("Select dates first");

    // Convert selectedDates Set to array and sort
    const datesArr = Array.from(selectedDates).sort();

    // Validate continuous dates (optional but recommended)
    for (let i = 1; i < datesArr.length; i++) {
      const prev = new Date(datesArr[i - 1]);
      const curr = new Date(datesArr[i]);
      prev.setDate(prev.getDate() + 1);
      if (curr.getTime() !== prev.getTime()) {
        return alert("Please select continuous dates only");
      }
    }

    const start = datesArr[0];
    const end = datesArr[datesArr.length - 1];

    const res = await fetch(WEBAPP_URL, {
      method: 'POST',
      body: JSON.stringify({ a_id, start, end }),
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    if (data.success) {
      alert("Booking successful!");
      selectedDates.clear();
      // Rerender calendar to refresh booked dates
      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';
      await initCalendar();
      updateBookButton();
    } else {
      alert("Booking failed: " + (data.error || "Unknown error"));
    }
  }

  document.getElementById('bookBtn').addEventListener('click', submitBooking);

  initCalendar();
</script>
</body>
</html>
