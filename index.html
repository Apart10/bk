<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Calendar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body { font-family:sans-serif; background:#f9fafb; padding:20px; }
    #calendar { max-width:600px; margin:auto; background:white; padding:20px; border-radius:8px; }
    .fc-day-past { background:#f0f0f0 !important; pointer-events:none; opacity:0.6; }
    .fc-day-available { background:#d1fae5 !important; cursor:pointer; }
    .fc-day-selected { background:#93c5fd !important; }
    .fc-event { background:#f87171 !important; border:none; pointer-events:none; opacity:0.8; }
    button { display:block; margin:20px auto; background:#2563eb; color:white; padding:10px 20px; border:none; border-radius:6px; font-size:16px; cursor:pointer; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Booking Calendar</h2>
  <div id="calendar"></div>
  <button id="bookBtn">Book Selected Dates</button>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search),
          a_id = params.get('a_id'),
          scriptUrl = 'https://script.google.com/macros/s/AKfycbxWJkk-Ayv5K7rhzMBgkkAs2_gzBgcUwqjMXdxlMshJRVS3epMHUKYdm8Ut_Vb6keRQ_g/exec';

    if (!a_id) { alert('Missing a_id'); throw 'No a_id'; }

    let booked = new Set(), selected = new Set();

    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'dayGridMonth',
      events: async (_, success, failure) => {
        try {
          const res = await fetch(`${scriptUrl}?mode=list&a_id=${a_id}`);
          if (!res.ok) throw `HTTP ${res.status}`;
          const j = await res.json();
          booked = new Set(j.dates);
          success(j.dates.map(d => ({ start: d, display: 'background' })));
        } catch (e) {
          alert('Error loading events: ' + e);
          failure(e);
        }
      },
      selectable: true,
      dateClick(info) {
        const d = info.dateStr,
              today = new Date().setHours(0,0,0,0);
        if (info.date.valueOf() < today || booked.has(d)) return;
        const el = info.dayEl;
        if (selected.has(d)) { selected.delete(d); el.classList.remove('fc-day-selected'); }
        else { selected.add(d); el.classList.add('fc-day-selected'); }
      },
      datesSet() {
        setTimeout(() => {
          document.querySelectorAll('.fc-daygrid-day').forEach(cell => {
            const d = cell.getAttribute('data-date'),
                  ts = new Date(d).setHours(0,0,0,0),
                  today = new Date().setHours(0,0,0,0);
            if (!d) return;
            if (ts < today) cell.classList.add('fc-day-past');
            else if (!booked.has(d)) cell.classList.add('fc-day-available');
          });
        }, 50);
      }
    });

    calendar.render();

    document.getElementById('bookBtn').onclick = async () => {
      if (!selected.size) return alert('Select at least one date');
      if (!confirm('Book dates:\n' + [...selected].join('\n'))) return;
      try {
        const res = await fetch(scriptUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ a_id, dates: [...selected], source: 'Owner' })
        });
        const j = await res.json();
        if (!j.success) throw j.error || 'Unknown error';
        alert('âœ… Booking successful');
        selected.clear();
        calendar.refetchEvents();
      } catch (e) {
        alert('Booking error: ' + e);
      }
    };
  </script>
</body>
</html>
