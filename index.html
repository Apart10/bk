<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apartment Booking Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
    #calendar { max-width: 600px; margin: auto; }
    #bookBtn { margin-top: 10px; width: 100%; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Apartment Booking Calendar (apt001)</h2>
<div id="calendar"></div>
<button id="bookBtn" disabled>Book Selected Dates</button>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxKf1SyYft1ClKgZgaaesA0PTf00lRi0Y4X9EHP30-uDzaWlMjz2HC4JTpXFAUDprxEUQ/exec'; // <-- Replace with your Apps Script Web App URL
  const a_id = 'apt001'; // Change apartment ID as needed
  let bookedRanges = [];
  let calendar;
  let selectedDates = [];

  // Format Date to YYYY-MM-DD for FullCalendar
  function formatYMD(date) {
    return date.toISOString().split('T')[0];
  }

  // Fetch bookings from backend
  async function fetchBookings() {
    const res = await fetch(`${WEBAPP_URL}?a_id=${a_id}`);
    const data = await res.json();
    if (data.error) {
      alert("Error fetching bookings: " + data.error);
      return [];
    }
    return data.bookings;
  }

  // Expand booking ranges into individual dates
  function expandDates(start, end) {
    let dates = [];
    let current = new Date(start);
    let last = new Date(end);
    while (current <= last) {
      dates.push(formatYMD(current));
      current.setDate(current.getDate() + 1);
    }
    return dates;
  }

  // Initialize calendar
  async function initCalendar() {
    const bookings = await fetchBookings();

    bookedRanges = [];
    let bookedDates = new Set();

    bookings.forEach(b => {
      const rangeDates = expandDates(b.start, b.end);
      rangeDates.forEach(d => bookedDates.add(d));
      bookedRanges.push({start: b.start, end: b.end});
    });

    const today = new Date();
    const pastDates = [];
    for(let d = new Date(today); d > new Date(today.getFullYear(), 0, 1); d.setDate(d.getDate() - 1)) {
      pastDates.push(formatYMD(d));
    }

    // Create FullCalendar instance
    const calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      selectable: true,
      selectOverlap: false,
      selectAllow: function(selectInfo) {
        // Don't allow selecting past dates or booked dates
        const start = selectInfo.startStr;
        const end = new Date(selectInfo.end);
        end.setDate(end.getDate() - 1); // FullCalendar exclusive end

        let current = new Date(start);
        while(current <= end) {
          const d = formatYMD(current);
          if (bookedDates.has(d) || new Date(d) < today) return false;
          current.setDate(current.getDate() + 1);
        }
        return true;
      },
      select: function(info) {
        selectedDates = [];
        const start = info.start;
        const end = new Date(info.end);
        end.setDate(end.getDate() - 1);
        let current = new Date(start);
        while (current <= end) {
          selectedDates.push(formatYMD(current));
          current.setDate(current.getDate() + 1);
        }
        updateBookButton();
      },
      unselect: function() {
        selectedDates = [];
        updateBookButton();
      },
      dayCellDidMount: function(info) {
        const d = info.date;
        const dateStr = formatYMD(d);

        // Grey out past dates
        if (d < today) {
          info.el.style.backgroundColor = '#eee';
          info.el.style.color = '#999';
        }
        // Red for booked
        else if (bookedDates.has(dateStr)) {
          info.el.style.backgroundColor = '#ff4d4d';
          info.el.style.color = 'white';
          info.el.style.pointerEvents = 'none';
        }
        // Green for available
        else {
          info.el.style.backgroundColor = '#b0f2b6';
          info.el.style.color = '#000';
        }
      }
    });

    calendar.render();
  }

  function updateBookButton() {
    const btn = document.getElementById('bookBtn');
    btn.disabled = selectedDates.length === 0;
  }

  // POST new booking
  async function submitBooking() {
    if (selectedDates.length === 0) return alert("Select dates first");

    const start = selectedDates[0];
    const end = selectedDates[selectedDates.length - 1];

    const res = await fetch(WEBAPP_URL, {
      method: 'POST',
      body: JSON.stringify({ a_id, start, end }),
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    if (data.success) {
      alert("Booking successful!");
      selectedDates = [];
      calendar.unselect();
      // Refresh calendar bookings
      calendar.destroy();
      await initCalendar();
      updateBookButton();
    } else {
      alert("Booking failed: " + (data.error || "Unknown error"));
    }
  }

  document.getElementById('bookBtn').addEventListener('click', submitBooking);

  initCalendar();
</script>
</body>
</html>
